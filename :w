package paste

import (
	"context"
	"os"
	"testing"
	"time"

	"Drop-Key/internal/db"
	"Drop-Key/internal/models"
	"Drop-Key/internal/user"

	"github.com/stretchr/testify/assert"
)

func setupTestService(t *testing.T) (*pasteService, func()) {
	t.Helper()
	ctx := context.Background()
	os.Setenv("DSN", "testuser:testpass@tcp(localhost:3306)/testdb?parseTime=true")
	db, err := db.InitDB(ctx)
	assert.NoError(t, err, "should initialize database")
	pasteRepo := NewPasteRepository(db)

	userRepo := user.NewUserRepositry(db)
	cleanup := func() {
		_, err := db.NewDropTable().Model(&models.Paste{}).IfExists().Exec(ctx)
		assert.NoError(t, err, "should drop Paste table")
		db.Close()
	}

	paste_service := NewPasteService(pasteRepo, userRepo)

	return paste_service, cleanup
}

func TestNewPasteService(t *testing.T) {
	service, cleanup := setupTestService(t)
	defer cleanup()

	assert.NotNil(t, service, "should not return a nil service.")
}

func TestCreate(t *testing.T) {
	service, cleanup := setupTestService(t)
	defer cleanup()

	ctx := context.Background()
	NotEncryptedPaste := &models.Paste{
		Ciphertext: "encrypted-data",
		Signature:  "signed-data",
		PublicKey:  "test-public-key",
	}
	id, err := service.Create(ctx, NotEncryptedPaste, 3600)
	assert.Error(t, err, "should retur error Ciphertext not base63 encrypted.")
	assert.NotNil(t, id, "should return a not-nil paste id")

	validPaste := &models.Paste{
		Ciphertext: "VGhpcyBpcyBhIHNhbXBsZSBzZWNyZXQgbWVzc2FnZQ==",                                             // "This is a sample secret message"
		PublicKey:  "WQX+3q+UKweEB9fUvImNMGnpER9slSuPBzLFeEkY+ik=",                                             // 32-byte Ed25519 public key
		Signature:  "4Ck7UOxki29bml3+pJSmKAYvDVGfU5e/IrNGWYyXQfRHUxyN3d8ov9v+lEqvArAh5o0Oni0uPU51lvAfvUE5Dw==", // Valid sig over Ciphertext
	}
	id, err = service.Create(ctx, validPaste, 3600)
	assert.NoError(t, err, "should create a paste.")
	assert.NotNil(t, validPaste.ID, "should return a not nil id.")
	assert.Greater(t, validPaste.ExpiresAt, time.Now().UTC().Truncate(time.Second), "should return paste with future expiry date.")

	emptyCipherPaste := &models.Paste{
		Signature: "signed-data",
		PublicKey: "test-public-key",
	}
	id, err = service.Create(ctx, emptyCipherPaste, 3600)
	assert.Error(t, err, "should return error for paste with empty Ciphertext")
	assert.Nil(t, emptyCipherPaste.ID, "should return paste with nil ID")

	expiredPaste := &models.Paste{
		Ciphertext: "encrypted-data",
		Signature:  "signed-data",
	}
	id, err = service.Create(ctx, expiredPaste, -3600)
	assert.Error(t, err, "should return error for expired paste.")
	assert.Nil(t, expiredPaste.ID, "should return paste with nil ID")
}
